# Marlin Kernel Deep Dive

## Marlin W4 format
In order to use Marlin kernel, we need to pack the data in correct format.
Let's use the 32x32 B matrix as an example.

### 1> Tiling to 16x16 blocks

First step is to tile B into 16x16 blocks, which is perfect input for m16n16k16 gemm.
Here is the layout of 32x32 matrix, each 16x16 block is separated by = and ||.

```
[   0,    1,    2,    3,    4,    5,    6,    7, |   8,    9,   10,   11,   12,   13,   14,   15, ||   16,   17,   18,   19,   20,   21,   22,   23, |  24,   25,   26,   27,   28,   29,   30,   31]
[  32,   33,   34,   35,   36,   37,   38,   39, |  40,   41,   42,   43,   44,   45,   46,   47, ||   48,   49,   50,   51,   52,   53,   54,   55, |  56,   57,   58,   59,   60,   61,   62,   63]
[  64,   65,   66,   67,   68,   69,   70,   71, |  72,   73,   74,   75,   76,   77,   78,   79, ||   80,   81,   82,   83,   84,   85,   86,   87, |  88,   89,   90,   91,   92,   93,   94,   95]
[  96,   97,   98,   99,  100,  101,  102,  103, | 104,  105,  106,  107,  108,  109,  110,  111, ||  112,  113,  114,  115,  116,  117,  118,  119, | 120,  121,  122,  123,  124,  125,  126,  127]
[ 128,  129,  130,  131,  132,  133,  134,  135, | 136,  137,  138,  139,  140,  141,  142,  143, ||  144,  145,  146,  147,  148,  149,  150,  151, | 152,  153,  154,  155,  156,  157,  158,  159]
[ 160,  161,  162,  163,  164,  165,  166,  167, | 168,  169,  170,  171,  172,  173,  174,  175, ||  176,  177,  178,  179,  180,  181,  182,  183, | 184,  185,  186,  187,  188,  189,  190,  191]
[ 192,  193,  194,  195,  196,  197,  198,  199, | 200,  201,  202,  203,  204,  205,  206,  207, ||  208,  209,  210,  211,  212,  213,  214,  215, | 216,  217,  218,  219,  220,  221,  222,  223]
[ 224,  225,  226,  227,  228,  229,  230,  231, | 232,  233,  234,  235,  236,  237,  238,  239, ||  240,  241,  242,  243,  244,  245,  246,  247, | 248,  249,  250,  251,  252,  253,  254,  255]
-------------------------------------------------|----------------------------------------------- || ------------------------------------------------|-----------------------------------------------
[ 256,  257,  258,  259,  260,  261,  262,  263, | 264,  265,  266,  267,  268,  269,  270,  271, ||  272,  273,  274,  275,  276,  277,  278,  279, | 280,  281,  282,  283,  284,  285,  286,  287]
[ 288,  289,  290,  291,  292,  293,  294,  295, | 296,  297,  298,  299,  300,  301,  302,  303, ||  304,  305,  306,  307,  308,  309,  310,  311, | 312,  313,  314,  315,  316,  317,  318,  319]
[ 320,  321,  322,  323,  324,  325,  326,  327, | 328,  329,  330,  331,  332,  333,  334,  335, ||  336,  337,  338,  339,  340,  341,  342,  343, | 344,  345,  346,  347,  348,  349,  350,  351]
[ 352,  353,  354,  355,  356,  357,  358,  359, | 360,  361,  362,  363,  364,  365,  366,  367, ||  368,  369,  370,  371,  372,  373,  374,  375, | 376,  377,  378,  379,  380,  381,  382,  383]
[ 384,  385,  386,  387,  388,  389,  390,  391, | 392,  393,  394,  395,  396,  397,  398,  399, ||  400,  401,  402,  403,  404,  405,  406,  407, | 408,  409,  410,  411,  412,  413,  414,  415]
[ 416,  417,  418,  419,  420,  421,  422,  423, | 424,  425,  426,  427,  428,  429,  430,  431, ||  432,  433,  434,  435,  436,  437,  438,  439, | 440,  441,  442,  443,  444,  445,  446,  447]
[ 448,  449,  450,  451,  452,  453,  454,  455, | 456,  457,  458,  459,  460,  461,  462,  463, ||  464,  465,  466,  467,  468,  469,  470,  471, | 472,  473,  474,  475,  476,  477,  478,  479]
[ 480,  481,  482,  483,  484,  485,  486,  487, | 488,  489,  490,  491,  492,  493,  494,  495, ||  496,  497,  498,  499,  500,  501,  502,  503, | 504,  505,  506,  507,  508,  509,  510,  511]
=====================================================================================================================================================================================================
[ 512,  513,  514,  515,  516,  517,  518,  519, | 520,  521,  522,  523,  524,  525,  526,  527, ||  528,  529,  530,  531,  532,  533,  534,  535, | 536,  537,  538,  539,  540,  541,  542,  543]
[ 544,  545,  546,  547,  548,  549,  550,  551, | 552,  553,  554,  555,  556,  557,  558,  559, ||  560,  561,  562,  563,  564,  565,  566,  567, | 568,  569,  570,  571,  572,  573,  574,  575]
[ 576,  577,  578,  579,  580,  581,  582,  583, | 584,  585,  586,  587,  588,  589,  590,  591, ||  592,  593,  594,  595,  596,  597,  598,  599, | 600,  601,  602,  603,  604,  605,  606,  607]
[ 608,  609,  610,  611,  612,  613,  614,  615, | 616,  617,  618,  619,  620,  621,  622,  623, ||  624,  625,  626,  627,  628,  629,  630,  631, | 632,  633,  634,  635,  636,  637,  638,  639]
[ 640,  641,  642,  643,  644,  645,  646,  647, | 648,  649,  650,  651,  652,  653,  654,  655, ||  656,  657,  658,  659,  660,  661,  662,  663, | 664,  665,  666,  667,  668,  669,  670,  671]
[ 672,  673,  674,  675,  676,  677,  678,  679, | 680,  681,  682,  683,  684,  685,  686,  687, ||  688,  689,  690,  691,  692,  693,  694,  695, | 696,  697,  698,  699,  700,  701,  702,  703]
[ 704,  705,  706,  707,  708,  709,  710,  711, | 712,  713,  714,  715,  716,  717,  718,  719, ||  720,  721,  722,  723,  724,  725,  726,  727, | 728,  729,  730,  731,  732,  733,  734,  735]
[ 736,  737,  738,  739,  740,  741,  742,  743, | 744,  745,  746,  747,  748,  749,  750,  751, ||  752,  753,  754,  755,  756,  757,  758,  759, | 760,  761,  762,  763,  764,  765,  766,  767]
-------------------------------------------------|----------------------------------------------- || ------------------------------------------------|-----------------------------------------------
[ 768,  769,  770,  771,  772,  773,  774,  775, | 776,  777,  778,  779,  780,  781,  782,  783, ||  784,  785,  786,  787,  788,  789,  790,  791, | 792,  793,  794,  795,  796,  797,  798,  799]
[ 800,  801,  802,  803,  804,  805,  806,  807, | 808,  809,  810,  811,  812,  813,  814,  815, ||  816,  817,  818,  819,  820,  821,  822,  823, | 824,  825,  826,  827,  828,  829,  830,  831]
[ 832,  833,  834,  835,  836,  837,  838,  839, | 840,  841,  842,  843,  844,  845,  846,  847, ||  848,  849,  850,  851,  852,  853,  854,  855, | 856,  857,  858,  859,  860,  861,  862,  863]
[ 864,  865,  866,  867,  868,  869,  870,  871, | 872,  873,  874,  875,  876,  877,  878,  879, ||  880,  881,  882,  883,  884,  885,  886,  887, | 888,  889,  890,  891,  892,  893,  894,  895]
[ 896,  897,  898,  899,  900,  901,  902,  903, | 904,  905,  906,  907,  908,  909,  910,  911, ||  912,  913,  914,  915,  916,  917,  918,  919, | 920,  921,  922,  923,  924,  925,  926,  927]
[ 928,  929,  930,  931,  932,  933,  934,  935, | 936,  937,  938,  939,  940,  941,  942,  943, ||  944,  945,  946,  947,  948,  949,  950,  951, | 952,  953,  954,  955,  956,  957,  958,  959]
[ 960,  961,  962,  963,  964,  965,  966,  967, | 968,  969,  970,  971,  972,  973,  974,  975, ||  976,  977,  978,  979,  980,  981,  982,  983, | 984,  985,  986,  987,  988,  989,  990,  991]
[ 992,  993,  994,  995,  996,  997,  998,  999, |1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007, || 1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015, |1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023]
```

2> Decide input for each thread

For each 16x16 tiles, we need to permute data to move together data used by one thread.

For example, thread 0 will use the following data: `[0,  32,  256,  288,   8,  40,  264, 296]`

```
[ { 0},    1,    2,    3,    4,    5,    6,    7, | { 8},    9,   10,   11,   12,   13,   14,   15, ||
[ {32},   33,   34,   35,   36,   37,   38,   39, | {40},   41,   42,   43,   44,   45,   46,   47, ||
[   64,   65,   66,   67,   68,   69,   70,   71, |   72,   73,   74,   75,   76,   77,   78,   79, ||
[   96,   97,   98,   99,  100,  101,  102,  103, |  104,  105,  106,  107,  108,  109,  110,  111, ||
[  128,  129,  130,  131,  132,  133,  134,  135, |  136,  137,  138,  139,  140,  141,  142,  143, ||
[  160,  161,  162,  163,  164,  165,  166,  167, |  168,  169,  170,  171,  172,  173,  174,  175, ||
[  192,  193,  194,  195,  196,  197,  198,  199, |  200,  201,  202,  203,  204,  205,  206,  207, ||
[  224,  225,  226,  227,  228,  229,  230,  231, |  232,  233,  234,  235,  236,  237,  238,  239, ||
--------------------------------------------------|------------------------------------------------ ||
[{256},  257,  258,  259,  260,  261,  262,  263, |{264},  265,  266,  267,  268,  269,  270,  271, ||
[{288},  289,  290,  291,  292,  293,  294,  295, |{296},  297,  298,  299,  300,  301,  302,  303, ||
[  320,  321,  322,  323,  324,  325,  326,  327, |  328,  329,  330,  331,  332,  333,  334,  335, ||
[  352,  353,  354,  355,  356,  357,  358,  359, |  360,  361,  362,  363,  364,  365,  366,  367, ||
[  384,  385,  386,  387,  388,  389,  390,  391, |  392,  393,  394,  395,  396,  397,  398,  399, ||
[  416,  417,  418,  419,  420,  421,  422,  423, |  424,  425,  426,  427,  428,  429,  430,  431, ||
[  448,  449,  450,  451,  452,  453,  454,  455, |  456,  457,  458,  459,  460,  461,  462,  463, ||
[  480,  481,  482,  483,  484,  485,  486,  487, |  488,  489,  490,  491,  492,  493,  494,  495, ||
======================================================================================================
```

3> Permute for fast conversion from int4 to fp16

In order to use fast interleaved_numeric_conversion, we need to rearrange the data in an interleaved way.

For example: `[0,  32,  256,  288,   8,  40,  264, 296]` => `[0,  256,    8,  264,  32, 288,  40, 296]`

Finially, the data is permuted to following layout (32, 4* 8 bytes)


```text
[   0,  256,    8,  264,   32,  288,   40,  296, |  16,  272,   24,  280,   48,  304,   56,  312, | 512,  768,  520,  776,  544,  800,  552,  808, | 528,  784,  536,  792,  560,  816,  568,  824,  
   64,  320,   72,  328,   96,  352,  104,  360, |  80,  336,   88,  344,  112,  368,  120,  376, | 576,  832,  584,  840,  608,  864,  616,  872, | 592,  848,  600,  856,  624,  880,  632,  888,  
  128,  384,  136,  392,  160,  416,  168,  424, | 144,  400,  152,  408,  176,  432,  184,  440, | 640,  896,  648,  904,  672,  928,  680,  936, | 656,  912,  664,  920,  688,  944,  696,  952,  
  192,  448,  200,  456,  224,  480,  232,  488, | 208,  464,  216,  472,  240,  496,  248,  504, | 704,  960,  712,  968,  736,  992,  744, 1000, | 720,  976,  728,  984,  752, 1008,  760, 1016,    
    1,  257,    9,  265,   33,  289,   41,  297, |  17,  273,   25,  281,   49,  305,   57,  313, | 513,  769,  521,  777,  545,  801,  553,  809, | 529,  785,  537,  793,  561,  817,  569,  825, 
   65,  321,   73,  329,   97,  353,  105,  361, |  81,  337,   89,  345,  113,  369,  121,  377, | 577,  833,  585,  841,  609,  865,  617,  873, | 593,  849,  601,  857,  625,  881,  633,  889,  
  129,  385,  137,  393,  161,  417,  169,  425, | 145,  401,  153,  409,  177,  433,  185,  441, | 641,  897,  649,  905,  673,  929,  681,  937, | 657,  913,  665,  921,  689,  945,  697,  953,  
  193,  449,  201,  457,  225,  481,  233,  489, | 209,  465,  217,  473,  241,  497,  249,  505, | 705,  961,  713,  969,  737,  993,  745, 1001, | 721,  977,  729,  985,  753, 1009,  761, 1017,  
    2,  258,   10,  266,   34,  290,   42,  298, |  18,  274,   26,  282,   50,  306,   58,  314, | 514,  770,  522,  778,  546,  802,  554,  810, | 530,  786,  538,  794,  562,  818,  570,  826,   
   66,  322,   74,  330,   98,  354,  106,  362, |  82,  338,   90,  346,  114,  370,  122,  378, | 578,  834,  586,  842,  610,  866,  618,  874, | 594,  850,  602,  858,  626,  882,  634,  890,  
  130,  386,  138,  394,  162,  418,  170,  426, | 146,  402,  154,  410,  178,  434,  186,  442, | 642,  898,  650,  906,  674,  930,  682,  938, | 658,  914,  666,  922,  690,  946,  698,  954,  
  194,  450,  202,  458,  226,  482,  234,  490, | 210,  466,  218,  474,  242,  498,  250,  506, | 706,  962,  714,  970,  738,  994,  746, 1002, | 722,  978,  730,  986,  754, 1010,  762, 1018,  
    3,  259,   11,  267,   35,  291,   43,  299, |  19,  275,   27,  283,   51,  307,   59,  315, | 515,  771,  523,  779,  547,  803,  555,  811, | 531,  787,  539,  795,  563,  819,  571,  827,  
   67,  323,   75,  331,   99,  355,  107,  363, |  83,  339,   91,  347,  115,  371,  123,  379, | 579,  835,  587,  843,  611,  867,  619,  875, | 595,  851,  603,  859,  627,  883,  635,  891,  
  131,  387,  139,  395,  163,  419,  171,  427, | 147,  403,  155,  411,  179,  435,  187,  443, | 643,  899,  651,  907,  675,  931,  683,  939, | 659,  915,  667,  923,  691,  947,  699,  955,  
  195,  451,  203,  459,  227,  483,  235,  491, | 211,  467,  219,  475,  243,  499,  251,  507, | 707,  963,  715,  971,  739,  995,  747, 1003, | 723,  979,  731,  987,  755, 1011,  763, 1019,
    4,  260,   12,  268,   36,  292,   44,  300, |  20,  276,   28,  284,   52,  308,   60,  316, | 516,  772,  524,  780,  548,  804,  556,  812, | 532,  788,  540,  796,  564,  820,  572,  828,  
   68,  324,   76,  332,  100,  356,  108,  364, |  84,  340,   92,  348,  116,  372,  124,  380, | 580,  836,  588,  844,  612,  868,  620,  876, | 596,  852,  604,  860,  628,  884,  636,  892,  
  132,  388,  140,  396,  164,  420,  172,  428, | 148,  404,  156,  412,  180,  436,  188,  444, | 644,  900,  652,  908,  676,  932,  684,  940, | 660,  916,  668,  924,  692,  948,  700,  956,  
  196,  452,  204,  460,  228,  484,  236,  492, | 212,  468,  220,  476,  244,  500,  252,  508, | 708,  964,  716,  972,  740,  996,  748, 1004, | 724,  980,  732,  988,  756, 1012,  764, 1020,   
    5,  261,   13,  269,   37,  293,   45,  301, |  21,  277,   29,  285,   53,  309,   61,  317, | 517,  773,  525,  781,  549,  805,  557,  813, | 533,  789,  541,  797,  565,  821,  573,  829,  
   69,  325,   77,  333,  101,  357,  109,  365, |  85,  341,   93,  349,  117,  373,  125,  381, | 581,  837,  589,  845,  613,  869,  621,  877, | 597,  853,  605,  861,  629,  885,  637,  893,  
  133,  389,  141,  397,  165,  421,  173,  429, | 149,  405,  157,  413,  181,  437,  189,  445, | 645,  901,  653,  909,  677,  933,  685,  941, | 661,  917,  669,  925,  693,  949,  701,  957,  
  197,  453,  205,  461,  229,  485,  237,  493, | 213,  469,  221,  477,  245,  501,  253,  509, | 709,  965,  717,  973,  741,  997,  749, 1005, | 725,  981,  733,  989,  757, 1013,  765, 1021,    
    6,  262,   14,  270,   38,  294,   46,  302, |  22,  278,   30,  286,   54,  310,   62,  318, | 518,  774,  526,  782,  550,  806,  558,  814, | 534,  790,  542,  798,  566,  822,  574,  830,   
   70,  326,   78,  334,  102,  358,  110,  366, |  86,  342,   94,  350,  118,  374,  126,  382, | 582,  838,  590,  846,  614,  870,  622,  878, | 598,  854,  606,  862,  630,  886,  638,  894,  
  134,  390,  142,  398,  166,  422,  174,  430, | 150,  406,  158,  414,  182,  438,  190,  446, | 646,  902,  654,  910,  678,  934,  686,  942, | 662,  918,  670,  926,  694,  950,  702,  958,  
  198,  454,  206,  462,  230,  486,  238,  494, | 214,  470,  222,  478,  246,  502,  254,  510, | 710,  966,  718,  974,  742,  998,  750, 1006, | 726,  982,  734,  990,  758, 1014,  766, 1022,  
    7,  263,   15,  271,   39,  295,   47,  303, |  23,  279,   31,  287,   55,  311,   63,  319, | 519,  775,  527,  783,  551,  807,  559,  815, | 535,  791,  543,  799,  567,  823,  575,  831,  
   71,  327,   79,  335,  103,  359,  111,  367, |  87,  343,   95,  351,  119,  375,  127,  383, | 583,  839,  591,  847,  615,  871,  623,  879, | 599,  855,  607,  863,  631,  887,  639,  895,  
  135,  391,  143,  399,  167,  423,  175,  431, | 151,  407,  159,  415,  183,  439,  191,  447, | 647,  903,  655,  911,  679,  935,  687,  943, | 663,  919,  671,  927,  695,  951,  703,  959,  
  199,  455,  207,  463,  231,  487,  239,  495, | 215,  471,  223,  479,  247,  503,  255,  511, | 711,  967,  719,  975,  743,  999,  751, 1007, | 727,  983,  735,  991,  759, 1015,  767, 1023]
```

4> Pack int4 to int32

Finally, pack continuous 8 bytes into one int32 with little endian, B shape: (32, 4(int32))

For example: 
```
byte/int4: [    0,  256,     8,  264,    32,  288,    40, 296] => 
int32:     [   b7,   b6,    b5,   b4,    b3,   b2,    b1,  b0]
           [{296}, {40}, {288}, {32}, {264},  {8}, {256}, {0}]

* Legend: {x}: byte at x position in the original data
```

